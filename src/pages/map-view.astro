---
import DefaultLayout from '@layouts/DefaultLayout.astro';
import { Leaflet, Marker, Popup, CreateLeafletIcon, Control, ControlLayer, LayerGroup, Overlay} from "astro-leaflet";
import { getCollection } from "astro:content";

const sites = await getCollection("sites", ({ data }) => {
  return data.Active == true;
});

const resourceTypesSet = new Set(sites.map(site => site.data['Primary Resource']));
const resourceTypes = [...resourceTypesSet];

const iconType = (resourceType) => {
  if (resourceType == "Free table") {
    return "free-table"
  } else if (['Distro', 'Fridge', 'Meals'].includes(resourceType)) {
    return resourceType.toLowerCase()
  } else {
    return "other"
  }
};

const layers = [
  {
    display: `<img class='legend-icon' src="/media/distro.svg" alt="Distro icon">Food distributions (Distros)`,
    name: "Distros",
    data: sites.filter(site => site.data['Primary Resource'] == "Distro")
  },
  {
    display: `<img class='legend-icon' src="/media/fridge.svg" alt="Fridge icon">Community fridges`,
    name: "Fridges",
    data: sites.filter(site => site.data['Primary Resource'] == "Fridge")
  },
  {
    display: `<img class='legend-icon' src="/media/freetable.svg" alt="Free table icon">Free tables`,
    name: "Free tables",
    data: sites.filter(site => site.data['Primary Resource'] == "Free table")
  },
  {
    display: `<img class='legend-icon' src="/media/meals.svg" alt="Meals icon">Meals`,
    name: "Meals",
    data: sites.filter(site => site.data['Primary Resource'] == "Meals")
  },
  {
    display: `<img class='legend-icon' src="/media/other.svg" alt="Non-food icon">Non-food`,
    name: "Non-food",
    data: sites.filter(site => !site.data['Food'])
  }
];

---

<DefaultLayout title="Map View">
    <div class="container mb-32">
        <h1 class="mb-10">Map View</h1>
        <p class="text-2xl mb-15">Use the interactive map below to find mutual aid near you.</p>
        <CreateLeafletIcon name="distro" options={{className: "leaflet-icon-distro", iconSize: [30,30]}} />
        <CreateLeafletIcon name="free-table" options={{className: "leaflet-icon-freetable", iconSize: [20,20]}} />
        <CreateLeafletIcon name="fridge" options={{className: "leaflet-icon-fridge", iconSize: [20,20]}} />
        <CreateLeafletIcon name="meals" options={{className: "leaflet-icon-meals", iconSize: [20,20]}} />
        <CreateLeafletIcon name="other" options={{className: "leaflet-icon-other", iconSize: [20,20]}} />
        <Leaflet
          id="map-quick-start"
          style=""
          options={{ center: [39.9925, -75.2411], zoom: 11 }}
        >
        <ControlLayer>
            {
              layers.map(layer => (
                <LayerGroup>
                  <Overlay name={layer.name}/>

                  {layer.data.map(site => (
                  <Marker latlng={[site.data.Latitude, site.data.Longitude]} options={{alt: site.data.Name}} astroIconName={iconType(site.data['Primary Resource'])}>
                    <Popup content=`
                      <h4 class="text-lg/5">${site.data.Name}</h4>
                      <p class="mt-3!">
                        <a href=${'https://www.google.com/maps/search/?api=1&query='+String(site.data.Latitude)+"+"+String(site.data.Longitude)}>${site.data.Address}</a><br>
                        ${site.data['Days and Times']}<br><br>
                        Description: ${site.data.Description}<br>
                        Types of resources: ${site.data['All Resources (New)']}<br>
                        Food: 
                      </p>`
                    />
                  </Marker>
                  ))}
                </LayerGroup>
            ))
          }
        </ControlLayer>
          <Control options={{position: 'bottomright'}}>
            <div class="info legend">
              <h2 class="text-lg">Legend</h2>
              <div class="map-legend-item">
                <p>
                <img class='legend-icon' src="/media/distro.svg" alt="Distro icon">
                Food distributions (Distros)
                </p>
              </div>
              <div class="map-legend-item">
                <p>
                <img class='legend-icon' src="/media/fridge.svg" alt="Fridge icon">
                Community fridges
                </p>
              </div>
              <div class="map-legend-item">
                <p>
                  <img class='legend-icon' src="/media/freetable.svg" alt="Free table icon">
                  Free tables
                </p>
              </div>
              <div class="map-legend-item">
                <p>
                  <img class='legend-icon' src="/media/meals.svg" alt="Meals icon">
                  Meals
                </p>
              </div>
              <div class="map-legend-item">
                <p>
                  <img class='legend-icon' src="/media/other.svg" alt="Non-food icon">
                  Non-food resources
                </p>
              </div>
            </div>
          </Control>
        </Leaflet>
        <h2 class="mt-5 mb-5">Downloadable maps</h2>
        <p class="text-xl">View static versions of food resources for:</p>
        <ul>
          <li><a href='/maps/North.pdf'>North Philly</a></li>
          <li><a href='/maps/South.pdf'>South Philly and Center City</a></li>
          <li><a href='/maps/West.pdf'>West Philly</a></li>
        </ul>
        <p class="text-xl">(last updated January 2nd, 2026)</p>
      </div>
<style is:global>
  .legend-icon {
    width: 2em;
    height: 2em;
    display: inline;
  }
	.leaflet-icon-distro {
		background-image: url("/media/distro.svg")
	}
  .leaflet-icon-freetable {
		background-image: url("/media/freetable.svg")
	}
  .leaflet-icon-fridge {
		background-image: url("/media/fridge.svg")
	}
  .leaflet-icon-meals {
		background-image: url("/media/meals.svg")
	}
  .leaflet-icon-other {
    background-image: url("/media/other.svg");
  }
  .legend {
    background-color: #ffffff;
    opacity: 0.7;
    padding: 10px;
    border-radius: 10px;
  }
  .legend:hover {
    opacity: 1;
  }
</style>
</DefaultLayout>